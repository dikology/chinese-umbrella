# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Enable verbose logging for better error visibility
# This helps prevent error truncation in CI
ENV["FASTLANE_VERBOSE"] = "true" if ENV["CI"] == "true"

default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    scan(
      project: "umbrella/umbrella.xcodeproj",
      scheme: "umbrella",
      # Let Fastlane auto-detect available simulators
      # This is more reliable across different environments
      ensure_devices_found: true,
      code_coverage: false,
      clean: true,
      # Use xcbeautify for proper Swift Testing output display
      xcodebuild_formatter: "xcbeautify",
      # Disable parallel testing for CI reliability
      # This prevents random freezes and ensures Swift Testing output is properly displayed
      # The scheme already has parallelizable="NO", but we add these args for extra safety
      xcargs: "-parallel-testing-worker-count 1 -parallel-testing-enabled NO",
      output_directory: "./fastlane/test_output",
      # xcbeautify doesn't support HTML output, only junit
      output_types: "junit",
      buildlog_path: "./fastlane/test_output"
    )
  end

  desc "Set up code signing with match"
  lane :setup_signing do
    unless ENV["MATCH_GIT_URL"]
      UI.important("‚ö†Ô∏è  MATCH_GIT_URL not set. Skipping match setup.")
      return
    end

    # In CI, always use appstore for TestFlight
    # Locally, allow override via EXPORT_METHOD for dev builds
    match_type =
      if ENV["CI"] == "true"
        "appstore"
      else
        (ENV["EXPORT_METHOD"] == "development" ? "development" : "appstore")
      end

    UI.message("Setting up match with type: #{match_type}")

    match_options = {
      type: match_type,
      app_identifier: "com.dikology.umbrella",
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: ENV["MATCH_GIT_BRANCH"] || "master",
      readonly: ENV["CI"] == "true",
      # Explicitly override Matchfile defaults
      force: false,
      skip_confirmation: true
    }

    # Add keychain options if provided (for CI)
    if ENV["MATCH_KEYCHAIN_NAME"]
      match_options[:keychain_name] = ENV["MATCH_KEYCHAIN_NAME"]
    end
    if ENV["MATCH_KEYCHAIN_PASSWORD"]
      match_options[:keychain_password] = ENV["MATCH_KEYCHAIN_PASSWORD"]
    end

    match(match_options)
  end

  desc "Build and archive the app"
  lane :build do
    # In CI, always app-store. Locally, allow dev override.
    export_method =
      if ENV["CI"] == "true"
        "app-store"
      else
        (ENV["EXPORT_METHOD"] || "app-store")
      end

    setup_signing if ENV["MATCH_GIT_URL"]

    build_app(
      project: "umbrella/umbrella.xcodeproj",
      scheme: "umbrella",
      configuration: "Release",
      export_method: export_method,
      output_directory: "./fastlane/build_output",
      clean: true,
      xcodebuild_formatter: "xcbeautify",
      buildlog_path: "./fastlane/build_output",
      export_options: {
        provisioningProfiles: {
          "com.dikology.umbrella" => (
            export_method == "development" ?
            "match Development com.dikology.umbrella" :
            "match AppStore com.dikology.umbrella"
          )
        },
        signingStyle: "manual"
      },
      xcargs: "-allowProvisioningUpdates"
    )
  end

  desc "Build and archive the app (local development - uses development export)"
  lane :build_local do
    ENV["EXPORT_METHOD"] = "development"
    build
  end

  desc "Upload to TestFlight"
  lane :beta do
    # Build and archive
    build

    # Upload to TestFlight
    # Prefer App Store Connect API key over username/password for CI
    upload_options = {
      skip_waiting_for_build_processing: false,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    }

    # Configure API key if available (for CI)
    # The api_key parameter expects the key content, not the file path
    if ENV["APP_STORE_CONNECT_API_KEY_ID"] && ENV["APP_STORE_CONNECT_ISSUER_ID"]
      key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
      issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]

      # Construct the key path - prefer explicit path, otherwise use default location
      key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
      if key_path.nil? || key_path.empty?
        key_path = File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{key_id}.p8")
      else
        key_path = File.expand_path(key_path)  # Ensure absolute path
      end

      UI.message("üîë Configuring App Store Connect API key")
      UI.message("   Key ID: #{key_id}")
      UI.message("   Issuer ID: #{issuer_id}")
      UI.message("   Key path: #{key_path}")

      # Verify the key file exists
      unless File.exist?(key_path)
        UI.user_error!("‚ùå App Store Connect API key file not found at: #{key_path}")
      end

      # Read the key file content
      key_content = File.read(key_path)

      # Pass the API key as a hash with the key content
      upload_options[:api_key] = {
        key_id: key_id,
        issuer_id: issuer_id,
        key: key_content,
        duration: 1200,  # optional, maximum 1200 seconds
        in_house: false  # optional
      }

      UI.message("‚úÖ API key configured and loaded")
    else
      UI.message("‚ö†Ô∏è  No API key found - will use username/password if available")
    end

    upload_to_testflight(upload_options)
  end

  desc "Capture screenshots for App Store"
  lane :screenshots do
    capture_screenshots(
      project: "umbrella/umbrella.xcodeproj",
      scheme: "umbrella",
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true,
      skip_open_summary: true
    )
  end

  desc "Upload screenshots and metadata to App Store"
  lane :upload_screenshots do
    # First capture screenshots
    screenshots

    # Upload to App Store
    upload_to_app_store(
      app_identifier: "com.dikology.umbrella",
      screenshots_path: "./fastlane/screenshots",
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: false,
      force: true
    )
  end

  desc "Run tests and upload to TestFlight if on main branch"
  lane :ci do
    # Always run tests
    test

    # Only deploy to TestFlight if on main branch and label is present
    if git_branch == "master" && ENV["DEPLOY_TO_TESTFLIGHT"] == "true"
      beta
    else
      UI.message("Skipping TestFlight deployment. Set DEPLOY_TO_TESTFLIGHT=true to deploy.")
    end
  end
end
